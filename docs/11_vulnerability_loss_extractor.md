# 11 - Vulnerability & Loss Extractor

**Notebook:** `notebook/11_rdls_vulnerability_loss_extractor.ipynb`

---

## Summary

Extracts detailed vulnerability and loss information from HDX datasets to populate RDLS metadata blocks.

**For Decision Makers:**
> This notebook identifies datasets about susceptibility factors (vulnerability) and historical/projected impacts (loss). These are often the most valuable datasets for risk assessment as they quantify actual consequences.

---

## Inputs

| Input | Path | Description |
|-------|------|-------------|
| Dataset JSONs | `dataset_metadata/*.json` | Raw HDX metadata |
| Signal dictionary | `config/signal_dictionary.yaml` | From Step 08 |
| Classification | `derived/classification_final.csv` | From Step 05 |

---

## Outputs

| Output | Path | Description |
|--------|------|-------------|
| Vulnerability extracts | `analysis/vulnerability_extracts.csv` | Per-dataset V info |
| Loss extracts | `analysis/loss_extracts.csv` | Per-dataset L info |
| V/L summary | `analysis/vulnerability_loss_summary.json` | Aggregate statistics |

---

## Vulnerability Categories

| Category | Description | Examples |
|----------|-------------|----------|
| **socioeconomic** | Economic and social factors | Poverty index, inequality |
| **physical** | Structural susceptibility | Building quality, materials |
| **capacity** | Coping and adaptation | Resilience, preparedness |
| **composite** | Multi-factor indices | HDI, vulnerability index |

---

## Loss Categories

| Category | Description | Examples |
|----------|-------------|----------|
| **human** | Lives and injuries | Casualties, fatalities |
| **economic** | Financial impacts | Damage costs, GDP loss |
| **physical** | Asset destruction | Buildings destroyed |
| **functional** | Service disruption | Displacement, outages |

---

## Attributes Extracted

### Vulnerability Attributes
| Attribute | Description | Example |
|-----------|-------------|---------|
| `vulnerability_category` | V type | "socioeconomic" |
| `indicator` | Specific measure | "poverty_headcount" |
| `unit` | Measurement unit | "percentage", "index" |
| `reference_period` | Data timeframe | "2020" |

### Loss Attributes
| Attribute | Description | Example |
|-----------|-------------|---------|
| `loss_category` | L type | "economic" |
| `loss_type` | Specific measure | "direct_damage" |
| `unit` | Measurement unit | "USD", "count" |
| `hazard_link` | Associated hazard | "flood" |
| `event_reference` | Specific event | "2019 Cyclone Idai" |

---

## Key Functions

### `VulnerabilityExtractor`
```python
extractor = VulnerabilityExtractor(signal_dictionary)
v_info = extractor.extract(dataset_json)
# v_info.category: str
# v_info.indicator: Optional[str]
# v_info.confidence: float
```

### `LossExtractor`
```python
extractor = LossExtractor(signal_dictionary)
l_info = extractor.extract(dataset_json)
# l_info.category: str
# l_info.loss_type: Optional[str]
# l_info.hazard_link: Optional[str]
```

---

## Vulnerability Detection Patterns

| Signal Pattern | Inferred Category |
|----------------|-------------------|
| poverty, income, wealth | socioeconomic |
| building age, construction, materials | physical |
| coping, resilience, preparedness | capacity |
| vulnerability index, HDI, composite | composite |

### Indicator Detection
```python
indicators = {
    "poverty_headcount": [r"poverty.*rate", r"headcount"],
    "gini_coefficient": [r"gini", r"inequality"],
    "hdi": [r"human development", r"HDI"],
    "resilience_score": [r"resilience", r"coping capacity"],
}
```

---

## Loss Detection Patterns

| Signal Pattern | Inferred Category |
|----------------|-------------------|
| casualties, fatalities, deaths | human |
| damage, losses, costs | economic |
| destroyed, collapsed, damaged | physical |
| displaced, evacuated, affected | functional |

### Loss Type Detection
```python
loss_types = {
    "direct_damage": [r"direct.*damage", r"physical.*loss"],
    "indirect_loss": [r"indirect", r"business interruption"],
    "mortality": [r"deaths", r"fatalities", r"casualties"],
    "displacement": [r"displaced", r"evacuated", r"homeless"],
}
```

---

## Statistics (Typical Run)

```
=== VULNERABILITY/LOSS EXTRACTION SUMMARY ===

Vulnerability datasets: 2,156 (8.2%)
  - socioeconomic: 1,024 (47.5%)
  - capacity: 538 (25.0%)
  - composite: 431 (20.0%)
  - physical: 163 (7.5%)

Loss datasets: 1,843 (7.0%)
  - economic: 774 (42.0%)
  - human: 516 (28.0%)
  - physical: 369 (20.0%)
  - functional: 184 (10.0%)

Attributes extracted:
  Vulnerability:
    - With indicator: 862 (40.0%)
    - With unit: 645 (29.9%)
  Loss:
    - With loss_type: 738 (40.0%)
    - With hazard_link: 923 (50.1%)
    - With event_reference: 412 (22.4%)
```

---

## Hazard-Loss Linkage

Loss datasets are often linked to specific hazards:

```python
hazard_links = {
    "flood": [r"flood.*damage", r"flood.*loss"],
    "earthquake": [r"earthquake.*damage", r"seismic.*loss"],
    "cyclone": [r"cyclone.*damage", r"typhoon.*loss"],
    "drought": [r"drought.*impact", r"crop.*loss"],
}
```

Example output:
```json
{
  "dataset_id": "abc123",
  "loss_category": "economic",
  "loss_type": "direct_damage",
  "hazard_link": "flood",
  "event_reference": "2019 Mozambique floods"
}
```

---

## Component Gating Reminder

Remember RDLS rules:
- Vulnerability requires hazard OR exposure
- Loss requires hazard OR exposure

Standalone V or L datasets are handled in Step 06 (auto-add exposure or block).

---

## How It Works

```
1. Load datasets classified as vulnerability or loss
2. For vulnerability datasets:
   a. Detect vulnerability category
   b. Extract indicator names
   c. Parse units and references
3. For loss datasets:
   a. Detect loss category
   b. Extract loss types
   c. Link to hazard if detectable
   d. Identify event references
4. Export extracts and summary
```

---

## Troubleshooting

### Low V/L detection rate
- V/L datasets are naturally less common (~15% of total)
- Many HDX datasets are primarily exposure
- Detection rate of 7-10% is normal

### Missing hazard link
- Not all loss data specifies the hazard
- Historical event data often lacks context
- Manual review may be needed for key datasets

### Ambiguous V vs. L
Some datasets blur the line (e.g., "food insecurity"):
- If measuring susceptibility → vulnerability
- If measuring actual outcomes → loss
- May assign both if appropriate

---

[← Previous: Exposure Extractor](10_exposure_extractor.md) | [Back to README](../README.md) | [Next: HEVL Integration →](12_hevl_integration.md)
